name: Run package tests

description: |
  Prepare the uv environment, execute pytest with coverage, and upload artifacts for a package.

inputs:
  package:
    description: Name of the package directory under packages/.
    required: true
  workers:
    description: Number of workers to use for pytest-xdist.
    required: true

runs:
  using: composite
  steps:
    - uses: ./.github/actions/setup-python
      with:
        sync-args: '--all-groups --all-extras --frozen --project packages/${{ inputs.package }}'

    - name: Run tests with code coverage report
      shell: bash
      run: |
        uv run pytest packages/${{ inputs.package }}/tests \
          --cov=packages/${{ inputs.package }}/src \
          --cov-config=.coveragerc \
          --cov-report term-missing \
          --cov-report xml:coverage-${{ inputs.package }}.xml
      env:
        CLEANUP_RAY_AFTER_TESTS: true
        UV_PROJECT: packages/${{ inputs.package }}

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ inputs.package }}
        path: coverage-${{ inputs.package }}.xml
        retention-days: 7

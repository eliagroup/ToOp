name: Run package tests

description: |
  Prepare the uv environment, execute pytest with coverage, and upload artifacts for a package.

inputs:
  package:
    description: Name of the package directory under packages/.
    required: true

runs:
  using: composite
  steps:
    - name: Check out repository code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version-file: packages/${{ inputs.package }}/pyproject.toml

    - name: Install dependencies
      shell: bash
      run: uv sync --all-groups --all-extras --frozen
      env:
        UV_PROJECT: packages/${{ inputs.package }}

    - name: set PY
      shell: bash
      run: echo "PY=$(python -VV | sha256sum | cut -d' ' -f1)" >> "$GITHUB_ENV"

    - name: Run tests with code coverage report
      shell: bash
      run: |
        uv run pytest -n auto --dist loadgroup packages/${{ inputs.package }}/tests \
          --cov=packages/${{ inputs.package }}/src \
          --cov-config=.coveragerc \
          --cov-report term-missing \
          --cov-report xml:coverage-${{ inputs.package }}.xml
      env:
        CLEANUP_RAY_AFTER_TESTS: true
        UV_PROJECT: packages/${{ inputs.package }}

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ inputs.package }}
        path: coverage-${{ inputs.package }}.xml
        retention-days: 7
